name: Build and Release

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # æ¨é€æ ‡ç­¾æ—¶è§¦å‘
  push:
    tags:
      - "v*"

# è®¾ç½®æƒé™
permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # å‡†å¤‡ç‰ˆæœ¬ä¿¡æ¯
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_tag: ${{ steps.version.outputs.version_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨ semver æ ¼å¼: 0.0.0-dev.YYYYMMDD.çŸ­hash
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            VERSION="0.0.0-dev.$(date +%Y%m%d).${SHORT_SHA}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  # æ„å»ºå‰ç«¯ï¼ˆå…±äº«ç»™æ‰€æœ‰å¹³å°ï¼‰
  build-web:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Update package versions
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          # æ›´æ–°æ ¹ç›®å½• package.json
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json
          # æ›´æ–° packages/web/package.json
          jq --arg v "$VERSION" '.version = $v' packages/web/package.json > tmp.json && mv tmp.json packages/web/package.json
          # æ›´æ–° packages/server/package.json
          jq --arg v "$VERSION" '.version = $v' packages/server/package.json > tmp.json && mv tmp.json packages/server/package.json

      - name: Install dependencies (root)
        run: bun install

      - name: Install dependencies (web)
        run: bun install
        working-directory: packages/web

      - name: Build web (for Electron)
        run: bun run build:web:electron

      - name: Verify web build uses relative paths
        run: |
          # æ£€æŸ¥ index.html æ˜¯å¦å­˜åœ¨
          if [ ! -f packages/web/dist/index.html ]; then
            echo "ERROR: packages/web/dist/index.html not found!"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆ./assets/ï¼‰è€Œä¸æ˜¯ç»å¯¹è·¯å¾„ï¼ˆ/assets/ï¼‰
          if grep -q 'src="/assets/' packages/web/dist/index.html; then
            echo "ERROR: Build uses absolute paths (/assets/). This will break Electron!"
            echo "Make sure BUILD_TARGET=electron is set during build."
            grep 'src="/' packages/web/dist/index.html
            exit 1
          fi
          
          if grep -q 'href="/assets/' packages/web/dist/index.html; then
            echo "ERROR: Build uses absolute paths (/assets/). This will break Electron!"
            echo "Make sure BUILD_TARGET=electron is set during build."
            grep 'href="/' packages/web/dist/index.html
            exit 1
          fi
          
          # éªŒè¯ä½¿ç”¨äº†ç›¸å¯¹è·¯å¾„
          if grep -q 'src="./assets/' packages/web/dist/index.html; then
            echo "OK: Build correctly uses relative paths (./assets/)"
          else
            echo "WARNING: Could not verify relative paths in index.html"
            cat packages/web/dist/index.html
          fi

      - name: Upload web build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: packages/web/dist
          retention-days: 1
          if-no-files-found: error

  # æ„å»º Docker é•œåƒï¼ˆåŒ…å«å‰ç«¯å’Œåç«¯ï¼‰
  build-docker:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # æ ‡ç­¾è§¦å‘æ—¶ä½¿ç”¨è¯­ä¹‰ç‰ˆæœ¬
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            # æ ‡ç­¾è§¦å‘æ—¶æ·»åŠ  latest
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨ dev æ ‡ç­¾
            type=raw,value=dev,enable=${{ github.event_name == 'workflow_dispatch' }}
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨ç‰ˆæœ¬å·æ ‡ç­¾
            type=raw,value=${{ needs.prepare.outputs.version }},enable=${{ github.event_name == 'workflow_dispatch' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          # ä»é¡¹ç›®æ ¹ç›®å½•æ„å»ºï¼Œä»¥åŒ…å«å‰ç«¯å’Œåç«¯
          context: .
          file: ./packages/server/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}

  # macOS æ„å»ºï¼ˆä½¿ç”¨ electron-builderï¼‰
  build-macos:
    needs: [prepare, build-web]
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: electron/web

      - name: Verify downloaded web build
        run: |
          if [ ! -f electron/web/index.html ]; then
            echo "ERROR: electron/web/index.html not found!"
            exit 1
          fi
          # å†æ¬¡éªŒè¯ç›¸å¯¹è·¯å¾„
          if grep -q 'src="/assets/' electron/web/index.html; then
            echo "ERROR: Web build uses absolute paths!"
            exit 1
          fi
          echo "OK: Web build verified"

      - name: Update Electron package version
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          cd electron
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json

      - name: Install Electron dependencies
        run: npm install
        working-directory: electron

      - name: Build Electron
        run: npm run build
        working-directory: electron

      - name: Package for macOS (x64 + arm64)
        run: npm run dist:mac
        working-directory: electron
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify macOS build artifacts exist
        run: |
          if [ -z "$(find electron/release -name '*.zip' -o -name '*.dmg' 2>/dev/null)" ]; then
            echo "ERROR: No macOS build artifacts found!"
            ls -la electron/release/ || true
            exit 1
          fi
          echo "OK: macOS build artifacts found"
          find electron/release -type f \( -name '*.zip' -o -name '*.dmg' \)

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            electron/release/*.dmg
            electron/release/*.zip
            electron/release/*.yml
            electron/release/*.yaml
            electron/release/*.blockmap
          retention-days: 7
          if-no-files-found: error

  # Windows æ„å»ºï¼ˆä½¿ç”¨ electron-builder + NSIS äº¤äº’å¼å®‰è£…ç¨‹åºï¼‰
  build-windows:
    needs: [prepare, build-web]
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: electron/web

      - name: Verify downloaded web build
        shell: pwsh
        run: |
          if (-not (Test-Path "electron/web/index.html")) {
            Write-Error "ERROR: electron/web/index.html not found!"
            exit 1
          }
          # éªŒè¯ç›¸å¯¹è·¯å¾„
          $content = Get-Content "electron/web/index.html" -Raw
          if ($content -match 'src="/assets/') {
            Write-Error "ERROR: Web build uses absolute paths!"
            exit 1
          }
          Write-Host "OK: Web build verified"

      - name: Update Electron package version
        shell: pwsh
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          cd electron
          $json = Get-Content package.json | ConvertFrom-Json
          $json.version = $version
          $json | ConvertTo-Json -Depth 100 | Set-Content package.json

      - name: Install Electron dependencies
        run: npm install
        working-directory: electron

      - name: Build Electron
        run: npm run build
        working-directory: electron

      - name: Package for Windows (NSIS installer x64 + arm64)
        run: npm run dist:win
        working-directory: electron
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Windows build artifacts exist
        shell: pwsh
        run: |
          $exeFiles = Get-ChildItem -Path "electron/release" -Filter "*.exe" -ErrorAction SilentlyContinue
          if (-not $exeFiles) {
            Write-Error "ERROR: No Windows .exe files found!"
            Get-ChildItem -Path "electron/release" -ErrorAction SilentlyContinue
            exit 1
          }
          Write-Host "OK: Windows build artifacts found"
          $exeFiles | ForEach-Object { Write-Host $_.FullName }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            electron/release/*.exe
            electron/release/*.zip
            electron/release/*.yml
            electron/release/*.yaml
            electron/release/*.blockmap
          retention-days: 7
          if-no-files-found: error

  # Linux æ„å»ºï¼ˆä½¿ç”¨ electron-builderï¼‰
  build-linux:
    needs: [prepare, build-web]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: electron/web

      - name: Verify downloaded web build
        run: |
          if [ ! -f electron/web/index.html ]; then
            echo "ERROR: electron/web/index.html not found!"
            exit 1
          fi
          # éªŒè¯ç›¸å¯¹è·¯å¾„
          if grep -q 'src="/assets/' electron/web/index.html; then
            echo "ERROR: Web build uses absolute paths!"
            exit 1
          fi
          echo "OK: Web build verified"

      - name: Update Electron package version
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          cd electron
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json

      - name: Install Electron dependencies
        run: npm install
        working-directory: electron

      - name: Build Electron
        run: npm run build
        working-directory: electron

      # å®‰è£… Linux æ‰“åŒ…æ‰€éœ€çš„ç³»ç»Ÿä¾èµ–ï¼ˆåŒ…æ‹¬ ARM64 äº¤å‰ç¼–è¯‘æ”¯æŒï¼‰
      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg fakeroot rpm

      - name: Package for Linux (x64 + arm64)
        run: npm run dist:linux
        working-directory: electron
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Linux build artifacts exist
        run: |
          if [ -z "$(find electron/release -name '*.AppImage' -o -name '*.deb' 2>/dev/null)" ]; then
            echo "ERROR: No Linux build artifacts found!"
            ls -la electron/release/ || true
            exit 1
          fi
          echo "OK: Linux build artifacts found"
          find electron/release -type f \( -name '*.AppImage' -o -name '*.deb' -o -name '*.rpm' \)

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            electron/release/*.AppImage
            electron/release/*.deb
            electron/release/*.rpm
            electron/release/*.yml
            electron/release/*.yaml
          retention-days: 7
          if-no-files-found: error

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: [prepare, build-docker]
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ vars.DEPLOY_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ vars.DEPLOY_PORT || 22 }}
          script: |
            cd ${{ vars.DEPLOY_PATH }}
            # æ‹‰å–æœ€æ–°é•œåƒ
            docker compose pull
            # é‡å¯æœåŠ¡
            docker compose up -d
            # æ¸…ç†æ—§é•œåƒ
            docker image prune -f

  # åˆ›å»º Releaseï¼ˆä»…åœ¨æ¨é€æ ‡ç­¾æ—¶ï¼‰
  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs:
      [prepare, build-macos, build-windows, build-linux, build-docker, deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: "*-build"
          merge-multiple: false

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Generate Release Notes with GitHub Copilot
        id: release_notes
        uses: actions/github-script@v7
        with:
          script: |
            // è·å–ç”¨äºæ¯”è¾ƒçš„åŸºå‡† commit
            let baseRef = '${{ github.event.before }}';

            // å¦‚æœ before æ˜¯å…¨é›¶ SHAï¼ˆæ–°åˆ›å»ºçš„ tagï¼‰ï¼Œåˆ™å°è¯•æ‰¾åˆ°ä¸Šä¸€ä¸ª tag
            if (!baseRef || baseRef === '0000000000000000000000000000000000000000') {
              try {
                // è·å–æ‰€æœ‰ tagsï¼ŒæŒ‰åˆ›å»ºæ—¶é—´æ’åº
                const { data: tags } = await github.rest.repos.listTags({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  per_page: 10
                });

                // æ‰¾åˆ°å½“å‰ tag ä¹‹å‰çš„ tag
                const currentTag = '${{ github.ref_name }}';
                let foundCurrent = false;
                for (const tag of tags) {
                  if (tag.name === currentTag) {
                    foundCurrent = true;
                    continue;
                  }
                  if (foundCurrent) {
                    baseRef = tag.commit.sha;
                    console.log(`Using previous tag ${tag.name} (${baseRef}) as base`);
                    break;
                  }
                }

                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¹‹å‰çš„ tagï¼Œè·å–æœ€è¿‘çš„ commits
                if (!baseRef || baseRef === '0000000000000000000000000000000000000000') {
                  const { data: recentCommits } = await github.rest.repos.listCommits({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    per_page: 20
                  });
                  if (recentCommits.length > 1) {
                    baseRef = recentCommits[Math.min(recentCommits.length - 1, 10)].sha;
                    console.log(`No previous tag found, using commit ${baseRef} as base`);
                  }
                }
              } catch (e) {
                console.log(`Error finding base ref: ${e.message}`);
              }
            }

            let commits = [];
            try {
              const { data: compareData } = await github.rest.repos.compareCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                base: baseRef,
                head: context.sha
              });
              commits = compareData.commits || [];
            } catch (e) {
              console.log(`Error comparing commits: ${e.message}`);
              // å¦‚æœæ¯”è¾ƒå¤±è´¥ï¼Œè·å–æœ€è¿‘çš„ commits ä½œä¸ºåå¤‡æ–¹æ¡ˆ
              try {
                const { data: recentCommits } = await github.rest.repos.listCommits({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: context.sha,
                  per_page: 20
                });
                commits = recentCommits;
              } catch (e2) {
                console.log(`Error fetching recent commits: ${e2.message}`);
              }
            }

            let notes = `## What's Changed in ${{ needs.prepare.outputs.version_tag }}\n\n`;

            const features = [];
            const fixes = [];
            const others = [];

            for (const commit of commits) {
              const msg = commit.commit.message.split('\n')[0];
              if (msg.startsWith('feat')) {
                features.push(`- ${msg}`);
              } else if (msg.startsWith('fix')) {
                fixes.push(`- ${msg}`);
              } else if (!msg.startsWith('Merge') && !msg.startsWith('chore')) {
                others.push(`- ${msg}`);
              }
            }

            if (features.length) {
              notes += `### âœ¨ Features\n${features.join('\n')}\n\n`;
            }
            if (fixes.length) {
              notes += `### ğŸ› Bug Fixes\n${fixes.join('\n')}\n\n`;
            }
            if (others.length) {
              notes += `### ğŸ“ Other Changes\n${others.join('\n')}\n\n`;
            }

            notes += `---\n\n`;
            notes += `## ğŸ“¦ Docker Image\n\n`;
            notes += `\`\`\`bash\n`;
            notes += `docker pull ghcr.io/${{ github.repository }}:${{ needs.prepare.outputs.version }}\n`;
            notes += `\`\`\`\n\n`;
            notes += `## ğŸ“¥ Downloads\n\n`;
            notes += `| Platform | Architecture | File |\n`;
            notes += `|----------|--------------|------|\n`;
            notes += `| Windows | x64 | \`PenBridge-Setup-${{ needs.prepare.outputs.version }}-x64.exe\` |\n`;
            notes += `| Windows | ARM64 | \`PenBridge-Setup-${{ needs.prepare.outputs.version }}-arm64.exe\` |\n`;
            notes += `| macOS | Intel (x64) | \`PenBridge-darwin-x64-${{ needs.prepare.outputs.version }}.zip\` |\n`;
            notes += `| macOS | Apple Silicon (ARM64) | \`PenBridge-darwin-arm64-${{ needs.prepare.outputs.version }}.zip\` |\n`;
            notes += `| Linux | x64 | \`PenBridge-${{ needs.prepare.outputs.version }}-x64.AppImage\` / \`.deb\` |\n`;
            notes += `| Linux | ARM64 | \`PenBridge-${{ needs.prepare.outputs.version }}-arm64.AppImage\` / \`.deb\` |\n`;

            core.setOutput('notes', notes);
            return notes;

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          name: "PenBridge ${{ needs.prepare.outputs.version_tag }}"
          body: ${{ steps.release_notes.outputs.notes }}
          generate_release_notes: true
          files: |
            artifacts/**/*.zip
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.AppImage
            artifacts/**/*.yml
            artifacts/**/*.yaml
            artifacts/**/*.blockmap
