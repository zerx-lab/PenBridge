name: Build and Release

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # æ¨é€æ ‡ç­¾æ—¶è§¦å‘
  push:
    tags:
      - "v*"

# è®¾ç½®æƒé™
permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # å‡†å¤‡ç‰ˆæœ¬ä¿¡æ¯
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_tag: ${{ steps.version.outputs.version_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨ semver æ ¼å¼: 0.0.0-dev.YYYYMMDD.çŸ­hash
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            VERSION="0.0.0-dev.$(date +%Y%m%d).${SHORT_SHA}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  # æ„å»ºå‰ç«¯ï¼ˆå…±äº«ç»™æ‰€æœ‰å¹³å°ï¼‰
  build-web:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Update package versions
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          # æ›´æ–°æ ¹ç›®å½• package.json
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json
          # æ›´æ–° packages/web/package.json
          jq --arg v "$VERSION" '.version = $v' packages/web/package.json > tmp.json && mv tmp.json packages/web/package.json
          # æ›´æ–° packages/server/package.json
          jq --arg v "$VERSION" '.version = $v' packages/server/package.json > tmp.json && mv tmp.json packages/server/package.json

      - name: Install dependencies (root)
        run: bun install

      - name: Install dependencies (web)
        run: bun install
        working-directory: packages/web

      - name: Build web
        run: bun run build:web

      - name: Upload web build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: packages/web/dist
          retention-days: 1

  # ç”Ÿæˆå›¾æ ‡ï¼ˆmacOS éœ€è¦ .icnsï¼ŒLinux éœ€è¦ .pngï¼‰
  build-icons:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install image tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick librsvg2-bin icnsutils

      # ä» SVG ç”Ÿæˆ PNGï¼ˆå¤šç§å°ºå¯¸ï¼‰
      - name: Generate PNG icons from SVG
        working-directory: electron/assets
        run: |
          # ç”Ÿæˆå„ç§å°ºå¯¸çš„ PNG
          for size in 16 32 48 64 128 256 512 1024; do
            rsvg-convert -w $size -h $size icon.svg -o icon_${size}.png
          done
          # å¤åˆ¶ 256x256 ä½œä¸ºé»˜è®¤ icon.pngï¼ˆLinux ä½¿ç”¨ï¼‰
          cp icon_256.png icon.png

      # ç”Ÿæˆ macOS icns æ–‡ä»¶
      - name: Generate macOS icns
        working-directory: electron/assets
        run: |
          mkdir -p icon.iconset
          cp icon_16.png icon.iconset/icon_16x16.png
          cp icon_32.png icon.iconset/icon_16x16@2x.png
          cp icon_32.png icon.iconset/icon_32x32.png
          cp icon_64.png icon.iconset/icon_32x32@2x.png
          cp icon_128.png icon.iconset/icon_128x128.png
          cp icon_256.png icon.iconset/icon_128x128@2x.png
          cp icon_256.png icon.iconset/icon_256x256.png
          cp icon_512.png icon.iconset/icon_256x256@2x.png
          cp icon_512.png icon.iconset/icon_512x512.png
          cp icon_1024.png icon.iconset/icon_512x512@2x.png
          # ä½¿ç”¨ png2icns ç”Ÿæˆ icnsï¼ˆicnsutils æä¾›ï¼‰
          png2icns icon.icns icon_16.png icon_32.png icon_48.png icon_128.png icon_256.png icon_512.png
          rm -rf icon.iconset icon_*.png

      - name: Upload icons artifact
        uses: actions/upload-artifact@v4
        with:
          name: icons
          path: |
            electron/assets/icon.png
            electron/assets/icon.icns
          retention-days: 1

  # æ„å»º Docker é•œåƒï¼ˆåŒ…å«å‰ç«¯å’Œåç«¯ï¼‰
  build-docker:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # æ ‡ç­¾è§¦å‘æ—¶ä½¿ç”¨è¯­ä¹‰ç‰ˆæœ¬
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            # æ ‡ç­¾è§¦å‘æ—¶æ·»åŠ  latest
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨ dev æ ‡ç­¾
            type=raw,value=dev,enable=${{ github.event_name == 'workflow_dispatch' }}
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨ç‰ˆæœ¬å·æ ‡ç­¾
            type=raw,value=${{ needs.prepare.outputs.version }},enable=${{ github.event_name == 'workflow_dispatch' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          # ä»é¡¹ç›®æ ¹ç›®å½•æ„å»ºï¼Œä»¥åŒ…å«å‰ç«¯å’Œåç«¯
          context: .
          file: ./packages/server/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}

  # macOS æ„å»º
  build-macos:
    needs: [prepare, build-web, build-icons]
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: electron/web

      - name: Download icons
        uses: actions/download-artifact@v4
        with:
          name: icons
          path: electron/assets

      - name: Update Electron package version
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          cd electron
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json

      - name: Install Electron dependencies
        run: npm install
        working-directory: electron

      - name: Build Electron
        run: npm run build
        working-directory: electron

      - name: Package for macOS (x64)
        run: npx electron-forge make --arch=x64
        working-directory: electron

      - name: Package for macOS (arm64)
        run: npx electron-forge make --arch=arm64
        working-directory: electron

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: electron/out/make/**/*
          retention-days: 7

  # Windows æ„å»ºï¼ˆä½¿ç”¨ electron-builder + NSIS äº¤äº’å¼å®‰è£…ç¨‹åºï¼‰
  build-windows:
    needs: [prepare, build-web]
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: electron/web

      - name: Update Electron package version
        shell: pwsh
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          cd electron
          $json = Get-Content package.json | ConvertFrom-Json
          $json.version = $version
          $json | ConvertTo-Json -Depth 100 | Set-Content package.json

      - name: Install Electron dependencies
        run: npm install
        working-directory: electron

      - name: Build Electron
        run: npm run build
        working-directory: electron

      - name: Package for Windows (NSIS installer)
        run: npm run dist:win
        working-directory: electron

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            electron/release/*.exe
            electron/release/*.zip
          retention-days: 7

  # Linux æ„å»º
  build-linux:
    needs: [prepare, build-web, build-icons]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: electron/web

      - name: Download icons
        uses: actions/download-artifact@v4
        with:
          name: icons
          path: electron/assets

      - name: Update Electron package version
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          cd electron
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json

      - name: Install Electron dependencies
        run: npm install
        working-directory: electron

      - name: Install Linux makers
        run: npm install --save-dev @electron-forge/maker-deb @electron-forge/maker-rpm
        working-directory: electron

      - name: Build Electron
        run: npm run build
        working-directory: electron

      # å®‰è£… Linux æ‰“åŒ…æ‰€éœ€çš„ç³»ç»Ÿä¾èµ–
      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg fakeroot rpm

      - name: Package for Linux
        run: npx electron-forge make --config forge.config.linux.ts
        working-directory: electron

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: electron/out/make/**/*
          retention-days: 7

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: [prepare, build-docker]
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ vars.DEPLOY_HOST }}
          username: ${{ vars.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ vars.DEPLOY_PORT || 22 }}
          script: |
            cd ${{ vars.DEPLOY_PATH }}
            # æ‹‰å–æœ€æ–°é•œåƒ
            docker compose pull
            # é‡å¯æœåŠ¡
            docker compose up -d
            # æ¸…ç†æ—§é•œåƒ
            docker image prune -f

  # åˆ›å»º Releaseï¼ˆä»…åœ¨æ¨é€æ ‡ç­¾æ—¶ï¼‰
  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs:
      [prepare, build-macos, build-windows, build-linux, build-docker, deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: "*-build"
          merge-multiple: false

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Generate Release Notes with GitHub Copilot
        id: release_notes
        uses: actions/github-script@v7
        with:
          script: |
            // è·å–ç”¨äºæ¯”è¾ƒçš„åŸºå‡† commit
            let baseRef = '${{ github.event.before }}';

            // å¦‚æœ before æ˜¯å…¨é›¶ SHAï¼ˆæ–°åˆ›å»ºçš„ tagï¼‰ï¼Œåˆ™å°è¯•æ‰¾åˆ°ä¸Šä¸€ä¸ª tag
            if (!baseRef || baseRef === '0000000000000000000000000000000000000000') {
              try {
                // è·å–æ‰€æœ‰ tagsï¼ŒæŒ‰åˆ›å»ºæ—¶é—´æ’åº
                const { data: tags } = await github.rest.repos.listTags({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  per_page: 10
                });

                // æ‰¾åˆ°å½“å‰ tag ä¹‹å‰çš„ tag
                const currentTag = '${{ github.ref_name }}';
                let foundCurrent = false;
                for (const tag of tags) {
                  if (tag.name === currentTag) {
                    foundCurrent = true;
                    continue;
                  }
                  if (foundCurrent) {
                    baseRef = tag.commit.sha;
                    console.log(`Using previous tag ${tag.name} (${baseRef}) as base`);
                    break;
                  }
                }

                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¹‹å‰çš„ tagï¼Œè·å–æœ€è¿‘çš„ commits
                if (!baseRef || baseRef === '0000000000000000000000000000000000000000') {
                  const { data: recentCommits } = await github.rest.repos.listCommits({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    per_page: 20
                  });
                  if (recentCommits.length > 1) {
                    baseRef = recentCommits[Math.min(recentCommits.length - 1, 10)].sha;
                    console.log(`No previous tag found, using commit ${baseRef} as base`);
                  }
                }
              } catch (e) {
                console.log(`Error finding base ref: ${e.message}`);
              }
            }

            let commits = [];
            try {
              const { data: compareData } = await github.rest.repos.compareCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                base: baseRef,
                head: context.sha
              });
              commits = compareData.commits || [];
            } catch (e) {
              console.log(`Error comparing commits: ${e.message}`);
              // å¦‚æœæ¯”è¾ƒå¤±è´¥ï¼Œè·å–æœ€è¿‘çš„ commits ä½œä¸ºåå¤‡æ–¹æ¡ˆ
              try {
                const { data: recentCommits } = await github.rest.repos.listCommits({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: context.sha,
                  per_page: 20
                });
                commits = recentCommits;
              } catch (e2) {
                console.log(`Error fetching recent commits: ${e2.message}`);
              }
            }

            let notes = `## What's Changed in ${{ needs.prepare.outputs.version_tag }}\n\n`;

            const features = [];
            const fixes = [];
            const others = [];

            for (const commit of commits) {
              const msg = commit.commit.message.split('\n')[0];
              if (msg.startsWith('feat')) {
                features.push(`- ${msg}`);
              } else if (msg.startsWith('fix')) {
                fixes.push(`- ${msg}`);
              } else if (!msg.startsWith('Merge') && !msg.startsWith('chore')) {
                others.push(`- ${msg}`);
              }
            }

            if (features.length) {
              notes += `### âœ¨ Features\n${features.join('\n')}\n\n`;
            }
            if (fixes.length) {
              notes += `### ğŸ› Bug Fixes\n${fixes.join('\n')}\n\n`;
            }
            if (others.length) {
              notes += `### ğŸ“ Other Changes\n${others.join('\n')}\n\n`;
            }

            notes += `---\n\n`;
            notes += `## ğŸ“¦ Docker Image\n\n`;
            notes += `\`\`\`bash\n`;
            notes += `docker pull ghcr.io/${{ github.repository }}:${{ needs.prepare.outputs.version }}\n`;
            notes += `\`\`\`\n\n`;
            notes += `## ğŸ“¥ Downloads\n\n`;
            notes += `| Platform | File |\n`;
            notes += `|----------|------|\n`;
            notes += `| Windows | \`PenBridge-Setup-${{ needs.prepare.outputs.version }}.exe\` |\n`;
            notes += `| macOS (Intel) | \`PenBridge-${{ needs.prepare.outputs.version }}-x64.dmg\` |\n`;
            notes += `| macOS (Apple Silicon) | \`PenBridge-${{ needs.prepare.outputs.version }}-arm64.dmg\` |\n`;
            notes += `| Linux (Debian/Ubuntu) | \`PenBridge-${{ needs.prepare.outputs.version }}.deb\` |\n`;
            notes += `| Linux (Fedora/RHEL) | \`PenBridge-${{ needs.prepare.outputs.version }}.rpm\` |\n`;

            core.setOutput('notes', notes);
            return notes;

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          name: "PenBridge ${{ needs.prepare.outputs.version_tag }}"
          body: ${{ steps.release_notes.outputs.notes }}
          generate_release_notes: true
          files: |
            artifacts/**/*.zip
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.AppImage
